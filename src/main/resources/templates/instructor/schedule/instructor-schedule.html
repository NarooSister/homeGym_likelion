<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Instructor Schedule</title>
  <style>
      body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 0;
          background-color: #f2f2f2;
      }

      h2 {
          text-align: center;
          margin-top: 30px;
      }

      #scheduleTableContainer {
          margin: 0 auto;
          width: 80%;
          overflow-x: auto;
      }

      table {
          border-collapse: collapse;
          width: 100%;
          margin-top: 20px;
      }

      th, td {
          border: 1px solid #ddd;
          padding: 8px;
          text-align: center;
          cursor: pointer;
          transition: background-color 0.3s;
      }

      th {
          background-color: #f2f2f2;
      }

      .selected {
          background-color: #8a2be2; /* 연보라색 */
      }

      #saveButton {
          display: block;
          margin: 20px auto;
          padding: 10px 20px;
          background-color: #4CAF50;
          border: none;
          color: white;
          cursor: pointer;
          border-radius: 5px;
          transition: background-color 0.3s;
      }

      #saveButton:hover {
          background-color: #45a049;
      }

      .btn {
          display: block;
          margin: 20px auto;
          padding: 10px 20px;
          background-color: #008CBA;
          border: none;
          color: white;
          cursor: pointer;
          border-radius: 5px;
          transition: background-color 0.3s;
          text-decoration: none;
          text-align: center;
          width: 200px;
      }

      .btn:hover {
          background-color: #005f6b;
      }
  </style>
</head>
<body>

<h2 th:text="${instructorName} + '님의 스케줄'"></h2>

<div id="scheduleTableContainer"></div>
<button id="saveButton">선택된 스케줄 저장</button>
<a href="/instructor/" class="btn">프로필로 돌아가기</a>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        initializeTable();
        fetchSavedSchedules();
        // 저장 버튼 클릭 시 선택된 스케줄 저장
        document.getElementById("saveButton").onclick = function () {
            saveSelectedSchedules();
        };
    });

    function fetchSavedSchedules() {
        fetch("/instructor/schedule/allSchedules")
            .then(response => response.json())
            .then(data => {
                displaySavedSchedules(data);
            })
            .catch(error => {
                console.error('Error fetching saved schedules:', error);
            });
    }

    // 저장된 스케줄을 표시하는 함수
    function displaySavedSchedules(savedSchedules) {
        const table = document.getElementById("scheduleTable");
        const cells = table.querySelectorAll(".cell");

        // 저장된 스케줄에 해당하는 셀의 선택 상태를 변경합니다.
        savedSchedules.forEach(schedule => {
            const { week, time } = schedule;
            const cell = table.querySelector(`td[data-week="${week}"][data-time="${time}"]`);
            if (cell) {
                cell.classList.add("selected");
            }
        });
    }

    // 요일과 시간대 정보
    const days = ["월", "화", "수", "목", "금", "토", "일"];
    const times = ["6시 - 9시", "9시 - 12시", "12시 - 15시", "15시 - 18시", "18시 - 21시", "21시 - 24시"];

    // 선택된 스케줄을 저장하는 배열
    let selectedSchedules = [];

    // 테이블을 생성하고 초기화하는 함수
    function initializeTable() {
        const scheduleTableContainer = document.getElementById("scheduleTableContainer");
        const table = document.createElement("table");
        table.id = "scheduleTable";
        const headerRow = table.insertRow();
        headerRow.insertCell(); // 빈 셀 추가

        // 요일 헤더 생성
        for (const week of days) {
            const th = document.createElement("th");
            th.textContent = week;
            headerRow.appendChild(th);
        }

        // 시간대별 행 생성
        for (const time of times) {
            const row = table.insertRow();
            const timeCell = row.insertCell();
            timeCell.textContent = time;

            // 각 요일별 셀 생성
            for (const week of days) {
                const cell = row.insertCell();
                cell.classList.add("cell");
                cell.setAttribute("data-week", week);
                cell.setAttribute("data-time", time);
                cell.onclick = function () {
                    toggleCellColor(this, week, time);
                };
            }
        }

        scheduleTableContainer.appendChild(table);
    }


    function toggleCellColor(cell, week, time) {
        if (cell.classList.contains("selected")) {
            cell.classList.remove("selected");
            removeSelectedSchedule(week, time);
        } else {
            cell.classList.add("selected");
            addSelectedSchedule(week, time);
        }
    }

    function addSelectedSchedule(week, time) {
        selectedSchedules.push({ week, time });
    }

    function removeSelectedSchedule(week, time) {
        selectedSchedules = selectedSchedules.filter(schedule => !(schedule.week === week && schedule.time === time));
    }

    // 선택된 스케줄을 저장하는 함수
    function saveSelectedSchedules() {
        fetch("/instructor/schedule/save", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(selectedSchedules)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to save schedules');
                }
                alert('스케줄이 성공적으로 저장되었습니다.');
                selectedSchedules = []; // 선택된 스케줄 배열 초기화
                fetchSavedSchedules(); // 저장된 스케줄 다시 불러오기
            })
            .catch(error => {
                console.error('Error saving schedules:', error);
                alert('스케줄 저장에 실패했습니다.');
            });
    }

</script>
</body>
</html>
