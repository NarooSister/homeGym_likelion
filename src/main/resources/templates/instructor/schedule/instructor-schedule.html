<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
    <title>Instructor Schedule</title>
  
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

  <style>
      body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 0;
          background-color: #f2f2f2;
      }

      h2 {
          text-align: center;
          margin-top: 30px;
      }

      #scheduleTableContainer {
          margin: 0 auto;
          width: 80%;
          overflow-x: auto;
      }

      table {
          border-collapse: collapse;
          width: 100%;
          margin-top: 20px;
      }

      th, td {
          border: 1px solid #ddd;
          padding: 8px;
          text-align: center;
          cursor: pointer;
          transition: background-color 0.3s;
      }

      th {
          background-color: #f2f2f2;
      }

      .selected {
          background-color: #8a2be2; /* 연보라색 */
      }

      #saveButton {
          display: block;
          margin: 20px auto;
          padding: 10px 20px;
          background-color: #4CAF50;
          border: none;
          color: white;
          cursor: pointer;
          border-radius: 5px;
          transition: background-color 0.3s;
      }

      #saveButton:hover {
          background-color: #45a049;
      }

      .btn {
          display: block;
          margin: 20px auto;
          padding: 10px 20px;
          background-color: #008CBA;
          border: none;
          color: white;
          cursor: pointer;
          border-radius: 5px;
          transition: background-color 0.3s;
          text-decoration: none;
          text-align: center;
          width: 200px;
      }

      .btn:hover {
          background-color: #005f6b;
      }
  </style>
</head>
<body>
  
  <div class="container mt-5">
    <h2 th:text="${instructorName} + '님의 스케줄'"></h2>

    <!-- 주소 등록 섹션 추가 -->
    <div class="card mb-3 mt-3">
        <div class="card-header">주소 등록</div>
        <div class="card-body">
            <form th:action="@{'/instructor/schedule/address'}" method="post">
                <label for="siDoSelect" class="form-label"></label>
                <select id="siDoSelect" name="siDo" class="form-select mr-2">
                    <option value="">시도 선택</option>
                    <!-- SiDo options will be dynamically populated here -->
                </select>
                <label for="siGunGuSelect" class="form-label"></label>
                <select id="siGunGuSelect" name="siGunGu" class="form-select mr-2">
                    <option value="">시군구 선택</option>
                    <!-- SiGunGu options will be dynamically populated here -->
                </select>
                <label for="dongSelect" class="form-label"></label>
                <select id="dongSelect" name="dong" class="form-select mr-2">
                    <option value="">동 선택</option>
                    <!-- Dong options will be dynamically populated here -->
                </select>
                <button type="submit" class="btn btn-outline-primary">주소 등록</button>
            </form>
        </div>
    </div>

    <!-- 주소 목록 섹션 추가 -->
    <div class="card mb-3">
        <div class="card-header">주소 목록</div>
        <div class="card-body">
            <table id="addressTable" class="table">
                <thead>
                <tr>
                    <th>시도</th>
                    <th>시군구</th>
                    <th>동</th>
                    <th>삭제</th>
                </tr>
                </thead>
                <tbody th:each="address : ${instructorAddresses}">
                <tr>
                    <td th:text="${address.siDo}"></td>
                    <td th:text="${address.siGunGu}"></td>
                    <td th:text="${address.dong}"></td>
                    <td>
                        <table>
                            <!-- 주소 삭제 폼 -->
                            <form th:action="@{'/instructor/schedule/address/' + ${address.id}}" method="post"
                                  onsubmit="return confirm('주소를 삭제하시겠습니까?');">
                                <input type="hidden" name="_method" value="delete"/>
                                <button type="submit" class="btn btn-outline-danger">삭제</button>
                            </form>
                        </table>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>


    <!-- 정렬 옵션 -->
    <div class="card mb-3">
        <div class="card-header">스케줄</div>
        <div class="card-body">
            <div class="mb-3">
                <label for="orderBy" class="form-label">정렬:</label>
                <select id="orderBy" name="orderBy" class="form-select" onchange="handleOrderBySelection(this)">
                    <option value="/instructor/schedule?orderBy=week" th:selected="${orderBy == 'week'}">요일순</option>
                    <option value="/instructor/schedule?orderBy=time" th:selected="${orderBy == 'time'}">시간순</option>
                </select>
            </div>

            <table class="table">
                <thead>
                <tr>
                    <th>요일</th>
                    <th>시간</th>
                    <th>생성 시간</th>
                    <th>수정 및 삭제</th>
                </tr>
                </thead>
                <tbody th:each="scheduleDto : ${scheduleDtos}">
                <tr>
                    <form th:action="@{/instructor/schedule/{scheduleId}(scheduleId=${scheduleDto.id})}" method="post"
                          onsubmit="return confirm('프로그램을 수정하시겠습니까?');">
                        <td>
                            <!-- 요일 선택 -->
                            <select name="week" class="form-select">
                                <option value="">요일 선택</option>
                                <option th:each="week : ${T(com.example.homeGym.instructor.entity.Week).values()}"
                                        th:value="${week.name()}" th:text="${week.koreanName}"
                                        th:selected="${week.name() == scheduleDto.week}">Week slot
                                </option>
                            </select>
                        </td>
                        <td>
                            <!-- 시간 선택 -->
                            <select name="time" class="form-select">
                                <option value="">시간 선택</option>
                                <option th:each="time : ${T(com.example.homeGym.instructor.entity.Time).values()}"
                                        th:value="${time.name()}" th:text="${time.description}"
                                        th:selected="${time.name() == scheduleDto.time}">Time slot
                                </option>
                            </select>
                        </td>
                        <td th:text="${#temporals.format(scheduleDto.createAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                        <td>
                            <table>
                                <!-- 스케줄 수정 폼 -->
                                <form th:action="@{'/instructor/schedule/' + ${scheduleDto.id}}" method="post"
                                      onsubmit="return confirm('스케줄을 수정하시겠습니까?');">
                                    <input type="hidden" name="_method" value="put"/>
                                    <button type="submit" class="btn btn-outline-warning mr-2">수정</button>
                                </form>
                                <!-- 스케줄 삭제 폼 -->
                                <form th:action="@{'/instructor/schedule/' + ${scheduleDto.id}}" method="post"
                                      onsubmit="return confirm('스케줄을 삭제하시겠습니까?');">
                                    <input type="hidden" name="_method" value="delete"/>
                                    <button type="submit" class="btn btn-outline-danger">삭제</button>
                                </form>
                            </table>
                        </td>
                    </form>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- 스케줄 생성 폼 -->

    <div class="card mb-3">
        <div class="card-header">새 스케줄 생성</div>
        <div class="card-body">
            <form th:action="@{'/instructor/schedule'}" method="post">
                <div class="form-group">
                    <label for="week" class="form-label">요일</label>
                    <select id="week" name="week" class="form-select" required>
                        <option value="">요일 선택</option>
                        <option th:each="week : ${T(com.example.homeGym.instructor.entity.Week).values()}"
                                th:value="${week.name()}" th:text="${week.koreanName}">Week slot
                        </option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="time" class="form-label">시간</label>
                    <select id="time" name="time" class="form-select" required>
                        <option value="">시간 선택</option>
                        <option th:each="time : ${T(com.example.homeGym.instructor.entity.Time).values()}"
                                th:value="${time.name()}" th:text="${time.description}">Time slot
                        </option>
                    </select>
                </div>
                <button type="submit" class="btn btn-outline-primary mr-1">스케줄 생성</button>
                <!-- 페이지로 돌아가는 버튼 -->
                <button type="button" class="btn btn-outline-success" onclick="goToInstructorPage()">프로필로 돌아가기</button>
            </form>
        </div>
    </div>
</div>
  

<div id="scheduleTableContainer"></div>
<button id="saveButton">선택된 스케줄 저장</button>
<a href="/instructor/" class="btn">프로필로 돌아가기</a>
  
  
<!-- Bootstrap JS 및 Popper.js -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        initializeTable();
        fetchSavedSchedules();
        // 저장 버튼 클릭 시 선택된 스케줄 저장
        document.getElementById("saveButton").onclick = function () {
            saveSelectedSchedules();
        };
    });

    function fetchSavedSchedules() {
        fetch("/instructor/schedule/allSchedules")
            .then(response => response.json())
            .then(data => {
                displaySavedSchedules(data);
            })
            .catch(error => {
                console.error('Error fetching saved schedules:', error);
            });
    }

    // 저장된 스케줄을 표시하는 함수
    function displaySavedSchedules(savedSchedules) {
        const table = document.getElementById("scheduleTable");
        const cells = table.querySelectorAll(".cell");

        // 저장된 스케줄에 해당하는 셀의 선택 상태를 변경합니다.
        savedSchedules.forEach(schedule => {
            const { week, time } = schedule;
            const cell = table.querySelector(`td[data-week="${week}"][data-time="${time}"]`);
            if (cell) {
                cell.classList.add("selected");
            }
        });
    }

    // 요일과 시간대 정보
    const days = ["월", "화", "수", "목", "금", "토", "일"];
    const times = ["6시 - 9시", "9시 - 12시", "12시 - 15시", "15시 - 18시", "18시 - 21시", "21시 - 24시"];

    // 선택된 스케줄을 저장하는 배열
    let selectedSchedules = [];

    // 테이블을 생성하고 초기화하는 함수
    function initializeTable() {
        const scheduleTableContainer = document.getElementById("scheduleTableContainer");
        const table = document.createElement("table");
        table.id = "scheduleTable";
        const headerRow = table.insertRow();
        headerRow.insertCell(); // 빈 셀 추가

        // 요일 헤더 생성
        for (const week of days) {
            const th = document.createElement("th");
            th.textContent = week;
            headerRow.appendChild(th);
        }

        // 시간대별 행 생성
        for (const time of times) {
            const row = table.insertRow();
            const timeCell = row.insertCell();
            timeCell.textContent = time;

            // 각 요일별 셀 생성
            for (const week of days) {
                const cell = row.insertCell();
                cell.classList.add("cell");
                cell.setAttribute("data-week", week);
                cell.setAttribute("data-time", time);
                cell.onclick = function () {
                    toggleCellColor(this, week, time);
                };
            }
        }

        scheduleTableContainer.appendChild(table);
    }


    function toggleCellColor(cell, week, time) {
        if (cell.classList.contains("selected")) {
            cell.classList.remove("selected");
            removeSelectedSchedule(week, time);
        } else {
            cell.classList.add("selected");
            addSelectedSchedule(week, time);
        }
    }

    function addSelectedSchedule(week, time) {
        selectedSchedules.push({ week, time });
    }

    function removeSelectedSchedule(week, time) {
        selectedSchedules = selectedSchedules.filter(schedule => !(schedule.week === week && schedule.time === time));
    }

    // 선택된 스케줄을 저장하는 함수
    function saveSelectedSchedules() {
        fetch("/instructor/schedule/save", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(selectedSchedules)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to save schedules');
                }
                alert('스케줄이 성공적으로 저장되었습니다.');
                selectedSchedules = []; // 선택된 스케줄 배열 초기화
                fetchSavedSchedules(); // 저장된 스케줄 다시 불러오기
            })
            .catch(error => {
                console.error('Error saving schedules:', error);
                alert('스케줄 저장에 실패했습니다.');
            });
      
      
      
      
      $(document).ready(function () {

        $.getJSON("address/siDo", function (data) {
            var siDoSelect = $("#siDoSelect");
            $.each(data, function (index, siDo) {
                siDoSelect.append($("<option></option>").attr("value", siDo).text(siDo));
            });
        });

        $("#siDoSelect").change(function () {
            var siDo = $(this).val();
            $("#siGunGuSelect").empty().append("<option value=''>시군구 선택</option>");
            $("#dongSelect").empty().append("<option value=''>동 선택</option>");

            if (!siDo) return;

            $.getJSON("address/siGunGu", {siDo: siDo}, function (data) {
                var siGunGuSelect = $("#siGunGuSelect");
                $.each(data, function (index, siGunGu) {
                    siGunGuSelect.append($("<option></option>").attr("value", siGunGu).text(siGunGu));
                });
            });
        });

        $("#siGunGuSelect").change(function () {
            var siGunGu = $(this).val();
            $("#dongSelect").empty().append("<option value=''>동 선택</option>");

            if (!siGunGu) return;

            $.getJSON("address/dong", {siGunGu: siGunGu}, function (data) {
                var dongSelect = $("#dongSelect");
                $.each(data, function (index, dong) {
                    dongSelect.append($("<option></option>").attr("value", dong).text(dong));
                });
            });
        });

    });

      
    }

</script>
</body>
</html>
